name: 🚀 Release Allure Report

on:
  workflow_dispatch:

jobs:
  run-full-suite:
    name: Run all critical tests
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout code
        uses: actions/checkout@v4

      - name: 🛠 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🧪 Run ALL tests (UI + Features)
        run: npm run test:all
        continue-on-error: true  # 👉 Evita que el job falle si hay tests fallidos

      - name: 🧷 Generate Allure Report
        run: npm run generate-allure-report

      - name: Set current date for folder name
        run: echo "RUN_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: 🕒 Set RUN_DATE output
        id: date
        run: echo "run_date=$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"
  
      - name: 🌐 Deploy Allure Report to GitHub Pages (TestAll/history/YYYY-MM-DD)
        env:
          RUN_DATE: ${{ steps.date.outputs.run_date }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./allure-report
          destination_dir: TestAll/history/${{ env.RUN_DATE }}
          ##https://rulycisnero.github.io/cypress-automationExercise/TestAll/history/2025-07-22/#
          ##https://rulycisnero.github.io/cypress-automationExercise/TestAll/history/2025-07-22/index.html


      - name: 🌐 Deploy Allure Report to GitHub Pages (TestAll/latest)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./allure-report
          destination_dir: TestAll/latest

      - name: 🔗 Generate link to Allure Report
        run: |
          echo "## 📊 Allure Report Link" > report-link.md
          echo "" >> report-link.md
          echo "[🔎 Ver último reporte](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/TestAll/latest/)" >> report-link.md

      - name: 📎 Adjuntar link al resumen del workflow
        uses: actions/upload-artifact@v4
        with:
          name: Allure Report Link
          path: report-link.md
